language: python
python:
  - "2.7"
# - Test against all supported Django versions with sqlite
# - Test against all supported databases with current Django
# - Run Selenium tests on current Django
# - Run pylint/pep8 checker
env:
  matrix:
    - DJANGO_PIP="Django>=1.6,<1.7" DO_LINT=1
    - DJANGO_PIP="Django>=1.7,<1.8" DO_LINT=1
    - DJANGO_PIP="Django>=1.7,<1.8" TRAVIS_DATABASE=mysql
    - DJANGO_PIP="Django>=1.7,<1.8" TRAVIS_DATABASE=postgresql
    - DJANGO_PIP="Django>=1.7,<1.8"
    - DJANGO_PIP="Django>=1.6,<1.7"
    - DJANGO_PIP="Django>=1.7,<1.8" TRAVIS_DATABASE=mysql TRAVIS_RUN_TESTS="-p test_selenium.py" DO_SELENIUM=1
  global:
    - secure: d0h5h+Lne5+BM14sbhIHKef6JksyZRoHxvQMKumZ5LTlb2WNx92GksVU5aT+RbWUUzyyXi9l+Ihpy9jNRSS2i7KSIymdkfV1g3sXWCQrBGT5Q29DDcKUbj+hWeZhRWk1dKV4Yndxgh9Pre+ivMjHr5lln3rJl1lA8hD+mnQu9HnEX2dH+G2HtNdcfSPe34Lk2/DX6sRms69RBbyZm5Fl4bG44u9NSUj3n0EzYc70DS9AaBIdG7DFxrR1XhhU7rgCel366yHZiaQNb16b0d+7iC3hhKhxWSvh8rD8+qrhuqxTUF7T2KuL6zr0btK8BCXxu/xavNrbv6phNU8IM6Y27g==
# commands to install dependencies
install:
  - pip install --download-cache $HOME/.pip-cache $DJANGO_PIP
  - pip install --download-cache $HOME/.pip-cache -r requirements.txt
  - pip install --download-cache $HOME/.pip-cache -r requirements-optional.txt
  - pip install --download-cache $HOME/.pip-cache -r travis/requirements.txt
  - pip install --download-cache $HOME/.pip-cache -r travis/requirements-${TRAVIS_DATABASE:-sqlite}.txt
  - pip install --download-cache $HOME/.pip-cache unittest-xml-reporting
# create databases
before_script:
  - mysql -e 'create database weblate;'
  - psql -c 'create database weblate;' -U postgres
  - if [ -n "$DO_SELENIUM" ] ; then curl -L https://gist.githubusercontent.com/santiycr/5139565/raw/sauce_connect_setup.sh | bash ; fi
  - echo -e "[server]\nmax_allowed_packet=64M\nwait_timeout=28800" | sudo tee -a /etc/mysql/conf.d/weblate.cnf
  - sudo service mysql restart
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
# commands to run tests
script:
  - if [ -n "$DO_LINT" ] ; then ./scripts/generate-locales ; fi
  - if [ -z "$DO_LINT" ] ; then ./manage.py validate --settings weblate.settings_test_shippable ; fi
  - if [ "$TRAVIS_DATABASE" = sqlite -a -z "$DO_LINT" ] ; then ./travis/migrate-testing ; fi
  - if [ -z "$DO_LINT" ] ; then ./manage.py syncdb --noinput --settings weblate.settings_test_shippable ; fi
  - if [ -z "$DO_LINT" ] ; then ./manage.py migrate --settings weblate.settings_test_shippable --traceback ; fi
  - if [ -z "$DO_LINT" ] ; then coverage run --source=. ./manage.py test --settings weblate.settings_test_shippable $TRAVIS_RUN_TESTS ; fi
  - if [ -n "$DO_LINT" ] ; then pep8 --exclude south_migrations,migrations weblate openshift ; fi
  - if [ -n "$DO_LINT" ] ; then pylint --rcfile=pylint.rc weblate ; fi
  - if [ -n "$DO_LINT" ] ; then pyflakes `find . -name '*.py' -not -name '__init__.py' -not -name 'settings_test_*.py' -not -name 'settings_test.py' -not -name 'settings_openshift.py'` ; fi
after_script:
  - if [ -z "$DO_LINT" ] ; then coverage xml -o shippable/codecoverage/coverage.xml ; fi
cache: true
matrix:
  allow_failures:
    - python: "2.7"
      env: DJANGO_PIP="Django>=1.7,<1.8" DO_LINT=1
