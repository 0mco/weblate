#!/bin/sh
# PIP deps installer
set -e
set -x

# Install tesseract
if [ -f $TESSERACT_PKG/tesseract.pc -a -f $TESSERACT_PKG/lept.pc ] ; then
    echo "Using cached tesseract"
else
    rm -rf $TESSERACT_INSTALL

    TMPDIR=`mktemp -d`
    OLDDIR=`pwd`
    cd $TMPDIR

    wget http://www.leptonica.org/source/leptonica-1.74.1.tar.gz
    tar xzf leptonica-1.74.1.tar.gz
    cd leptonica-1.74.1
    ./configure --prefix=$TESSERACT_INSTALL
    make install
    cd ..

    export LIBLEPT_HEADERSDIR="$TESSERACT_INSTALL/include"
    export LDFLAGS="-L$TESSERACT_INSTALL/lib"
    export CFLAGS="-I$TESSERACT_INSTALL/include"

    wget https://github.com/tesseract-ocr/tesseract/archive/3.04.01.tar.gz
    tar xzf 3.04.01.tar.gz
    cd tesseract-3.04.01
    ./configure --prefix=$TESSERACT_INSTALL
    make install

    cd $OLDDIR
fi
tar cfz tesseract.tar.gz $TESSERACT_INSTALL

# Get newer pip and whell for binary caching support
pip install --upgrade pip wheel

# Install PyPI packages
pip install $CI_PIP_DEPS
pip install Cython
pip install \
    -r requirements-optional.txt \
    -r ci/requirements-${CI_REQUIREMENTS}.txt \
    -r ci/requirements-${CI_DATABASE:-sqlite}.txt
